import React, { Component } from 'react';
import PropTypes from 'prop-types';

import Collection from '../../Collection';
import StoriesAPIClient from '../client';


/**
* Collection generated by the Stories-API endpoint.
*/
export default class StoriesAPICollection extends Component {
  static propTypes = {
    /** API Key to interact with the StoriesAPI */
    apiKey: PropTypes.string.isRequired,
    /** Override `StoriesAPI` data fetching to use custom data */
    data: PropTypes.object,
    /** `StoriesAPI` endpoint URL */
    endpoint: PropTypes.string.isRequired,
    /** Current Browsing Page Number */
    page: PropTypes.number,
    /** StoriesAPI collection id */
    id: PropTypes.number.isRequired,
    /** Props to pass to the `Story` component */
    options: PropTypes.object,

  };

  static defaultProps = {
    data: null,
    endpoint: process.env.STORIES_API_URL,
    options: {},
    page: 1,
  };

  constructor(props) {
    super(props);
    const { apiKey, data, page, endpoint } = props;
    this.state = {
      loading: data ? false : true,
      data: data,
      count: null,
      stories: [],
      page: page || 1,
      search: null,
    };

    this.client = new StoriesAPIClient(endpoint, apiKey);
    this.handlePageChange = this.handlePageChange.bind(this);
    this.handleSearch = this.handleSearch.bind(this);
    this.handleSearchInput = this.handleSearchInput.bind(this);
  };

  componentDidMount() {
    if (!this.state.data) {
      this.setState({ loading: true }, () => {
        this.fetchData(() => {
          this.fetchCount(() => {
            this.fetchStories(() => {
              this.setState({loading: false});
            });
          })
        })
      });
    }
  };

  fetchData(callback) {
    const { id } = this.props;
    return this.client.collection(id, data => {
       this.setState({data: data});
       return callback(data);
     });
  };

  fetchStories(callback) {
    const {  endpoint, id } = this.props;
    const { page, search } = this.state;
    return this.client.story('', id, page, search, stories => {
       this.setState({stories: stories});
       return callback(stories);
     });
  };

  fetchCount(callback) {
    const { id } = this.props;
    return this.client.story('count', id, null, null, ({count}) => {
       this.setState({count: count});
       return callback(count);
     });
  };

  handlePageChange({ selected }) {
    const newPage = selected + 1;
    if (newPage == this.state.page) return;
    this.setState({page: newPage, loading: true}, () => {
      this.fetchStories(() => {
        this.setState({loading: false});
      })
    })
  }
  handleSearchInput(event){
    this.setState({search: event.target.value});
  }

  handleSearch(event) {
    event.preventDefault(); // prevent form from reloading page
    const searchQuery = this.state.search;
    this.setState({page: 1, loading: true},
      () => {
      this.fetchStories(() => {
        this.setState({loading: false});
      })
    })
  }

  render() {
    const { urlFormatter } = this.props;
    const { count, data, loading, page, options, search, stories } = this.state;

    return (
      <Collection
        loading={loading}
        stories={stories}
        {...data}
        count={count}
        page={page}
        urlFormatter={urlFormatter}
        onPageChange={this.handlePageChange}
        search={search}
        onSearchInput={this.handleSearchInput}
        onSearch={this.handleSearch}
        {...options}
      />
    );
  }
};
