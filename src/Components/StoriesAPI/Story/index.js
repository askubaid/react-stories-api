import React, { Component } from 'react';
import { Container, LinearProgress, Typography } from '@material-ui/core';
import PropTypes from 'prop-types';

import Story from '../../Story';
import StoriesAPIClient from '../client';
import { MomentUtils } from './utils';

/**
* Story generated by the Stories-API endpoint.
*/
export default class StoriesAPIStory extends Component {
  static propTypes = {
    /** API Key to interact with the StoriesAPI */
    apiKey: PropTypes.string.isRequired,
    /** StoriesAPI collection id */
    collection: PropTypes.number,
    /** Override `StoriesAPI` data fetching to use custom data */
    data: PropTypes.object,
    /** `StoriesAPI` endpoint URL */
    endpoint: PropTypes.string.isRequired,
    /** Identifier of the `Story` */
    id: PropTypes.oneOfType([PropTypes.number, PropTypes.string]).isRequired,
    /** Props to pass to the `Story` component */
    options: PropTypes.object,

  };

  static defaultProps = {
    collection: null,
    data: null,
    endpoint: process.env.STORIES_API_URL,
    options: {},
  };

  constructor(props) {
    super(props);
    const { apiKey, data, endpoint } = props;
    this.state = {
      loading: data ? false : true,
      data: data,
      error: false,
    };

    this.client = new StoriesAPIClient(endpoint, apiKey);
    this.setError = this.setError.bind(this);
  };

  componentDidMount() {
    if (!this.state.data) {
      this.setState({ loading: true });
      this.fetchData(data => {
        this.setState({loading: false});
      });
    }
  };

  setError() {
    this.setState({error: true})
  };

  fetchData(callback) {
    const { collection, endpoint, id, onLoad } = this.props;
    return this.client.story(id, collection, null, null, story => {
       this.setState({data: story});
       onLoad && onLoad(story);
       return callback(story);
     }, this.setError);
  };

  renderMoments(){
    const { data } = this.state;

    const storyMoments = [];
    data.moments.map(moment => {
      const { type } = moment;
      if (MomentUtils.isPublicMoment(moment)) {
        const index = storyMoments.length;
        storyMoments.push(MomentUtils.buildMoment(moment, index));
      }
    })
    return storyMoments;
  }

  renderLoading(){
    const { loading } = this.state;
    return loading && (
      <Container style={{textAlign: "center"}}>
        <Typography variant="h5" color="primary">
          Building Your Story ...
        </Typography>
        <LinearProgress color="secondary" />
      </Container>
    );
  };

  renderError(){
    const { errorComponent } = this.props;
    return errorComponent || (
        <Typography>
          Something went wrong while loading this collection... <br/>
          Try Refreshing or Check Back Soon
        </Typography>
    );
  };

  render() {
    const { options } = this.props;
    const { error, data, loading } = this.state;
    return error ? this.renderError() : this.renderLoading() || (
      <Story {...data} {...options}>
        {this.renderMoments()}
      </Story>
    );
  }
}
